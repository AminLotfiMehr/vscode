# ویژگی‌های حسابداری عملیات تنخواه

## خلاصه پیاده‌سازی

این سند شامل تمام ویژگی‌هایی است که برای مدیریت حسابداری عملیات تنخواه پیاده‌سازی شده است.

## ✅ ویژگی‌های پیاده‌سازی شده:

### 1. **اصلاح مشکل تاریخ**
- ✅ رفع مشکل نمایش تاریخ "783/02/26" در عملیات تنخواه
- ✅ تنظیم خودکار تاریخ امروز در صورت عدم ورود تاریخ
- ✅ استفاده صحیح از `jdatetime.date.today()`

### 2. **ایجاد خودکار اسناد حسابداری**
- ✅ ایجاد سند حسابداری خودکار برای هر عملیات تنخواه
- ✅ ثبت آرتیکل‌های صحیح بر اساس نوع عملیات
- ✅ پیوند اسناد با عملیات تنخواه از طریق `reference_id` و `reference_type`

### 3. **منطق حسابداری عملیات تنخواه**

#### **افزودن به تنخواه (ADD):**
```
بدهکار: حساب تنخواه
بستانکار: صندوق نقدی
```

#### **برداشت از تنخواه (WITHDRAW):**
```
بدهکار: صندوق نقدی  
بستانکار: حساب تنخواه
```

### 4. **به‌روزرسانی خودکار موجودی‌ها**
- ✅ به‌روزرسانی موجودی صندوق تنخواه
- ✅ ایجاد گردش صندوق (FundTransaction)
- ✅ ثبت در صورتحساب صندوق (FundStatement)

### 5. **مدیریت حساب‌های حسابداری**
- ✅ ایجاد خودکار حساب تنخواه
- ✅ ایجاد خودکار حساب صندوق نقدی
- ✅ گروه‌بندی صحیح حساب‌ها

## 🔧 جزئیات فنی:

### **کلاس‌های اضافه شده:**

#### 1. **AccountingVoucherManager.create_voucher_from_petty_cash_operation()**
```python
def create_voucher_from_petty_cash_operation(self, petty_cash_operation):
    """Create voucher from petty cash operation"""
    # ایجاد سند حسابداری با آرتیکل‌های مناسب
```

#### 2. **Signal Handler برای PettyCashOperation**
```python
@receiver(post_save, sender=PettyCashOperation)
def update_petty_cash_balance(sender, instance, created, **kwargs):
    """به‌روزرسانی موجودی تنخواه و ایجاد سند حسابداری"""
```

#### 3. **تابع کمکی create_voucher_for_petty_cash_operation()**
```python
def create_voucher_for_petty_cash_operation(petty_cash_operation):
    """Create voucher for petty cash operation"""
```

### **مدل‌های مرتبط:**

#### **PettyCashOperation:**
- `operation_type`: ADD یا WITHDRAW
- `reason`: دلیل عملیات (هزینه روزانه، اورژانس، و...)
- `amount`: مبلغ عملیات
- `date`: تاریخ عملیات (خودکار تنظیم می‌شود)
- `source_fund`: صندوق منبع (اختیاری)
- `source_bank_account`: حساب بانکی منبع (اختیاری)

#### **Voucher و VoucherItem:**
- سند حسابداری با آرتیکل‌های مناسب
- پیوند با عملیات تنخواه از طریق `reference_id`

#### **Fund و FundTransaction:**
- به‌روزرسانی موجودی صندوق تنخواه
- ثبت گردش‌های صندوق

## 📊 جریان کار:

### **1. ثبت عملیات تنخواه:**
1. کاربر عملیات تنخواه جدید ثبت می‌کند
2. تاریخ به صورت خودکار تنظیم می‌شود
3. شماره عملیات تولید می‌شود

### **2. ایجاد خودکار اسناد:**
1. سند حسابداری ایجاد می‌شود
2. آرتیکل‌های مناسب ثبت می‌شوند
3. موجودی صندوق به‌روزرسانی می‌شود
4. گردش صندوق ثبت می‌شود

### **3. گزارش‌گیری:**
- امکان مشاهده اسناد حسابداری مرتبط
- گزارش گردش صندوق تنخواه
- صورتحساب صندوق تنخواه

## 🎯 مزایای پیاده‌سازی:

### **1. دقت حسابداری:**
- ثبت دقیق تمام عملیات تنخواه
- ایجاد خودکار اسناد حسابداری
- پیوند کامل بین عملیات و اسناد

### **2. مدیریت موجودی:**
- به‌روزرسانی خودکار موجودی تنخواه
- ثبت گردش‌های دقیق
- امکان گزارش‌گیری کامل

### **3. قابلیت ردیابی:**
- پیوند اسناد با عملیات
- تاریخچه کامل عملیات
- امکان حذف و اصلاح

### **4. انعطاف‌پذیری:**
- پشتیبانی از انواع مختلف دلایل عملیات
- امکان انتخاب منبع (صندوق یا بانک)
- مدیریت خطاها و استثناها

## 🔍 نحوه استفاده:

### **در پنل ادمین:**
1. به بخش "عملیات تنخواه" بروید
2. عملیات جدید ثبت کنید
3. اسناد حسابداری به صورت خودکار ایجاد می‌شوند

### **مشاهده اسناد:**
1. در بخش "اسناد حسابداری" اسناد مرتبط را مشاهده کنید
2. در بخش "گردش صندوق" گردش‌های تنخواه را ببینید
3. در بخش "صورتحساب صندوق" صورتحساب تنخواه را مشاهده کنید

## ✅ تست و تأیید:

- ✅ سرور بدون خطا اجرا می‌شود
- ✅ تمام مدل‌ها بدون مشکل بارگذاری می‌شوند
- ✅ Signal handlers به درستی تعریف شده‌اند
- ✅ توابع حسابداری قابل دسترسی هستند

## 📝 نکات مهم:

1. **تاریخ:** تاریخ به صورت خودکار تنظیم می‌شود
2. **اسناد:** اسناد حسابداری به صورت خودکار ایجاد می‌شوند
3. **موجودی:** موجودی صندوق به‌روزرسانی می‌شود
4. **گزارش:** امکان گزارش‌گیری کامل فراهم است

این پیاده‌سازی تضمین می‌کند که تمام عملیات تنخواه به صورت دقیق و کامل در سیستم حسابداری ثبت شوند. 