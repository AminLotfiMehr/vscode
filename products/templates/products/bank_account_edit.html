{% extends 'products/base.html' %}
{% load custom_filters %}
{% block title %}{{ title }}{% endblock %}

{% block customer_elements %}{% endblock customer_elements %}{% block cart_elements %}{% endblock cart_elements %}

{% block content %}
<style>
  .bank-account-edit-container {
    max-width: 1200px;
    margin: 20px auto;
    background: rgba(255,255,255,0.05);
    border-radius: 24px;
    padding: 24px 24px 18px 24px;
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    font-family: 'b homa', Tahoma, sans-serif;
    box-sizing: border-box;
    transition: all 0.25s;
    overflow: hidden;
  }
  
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
  }
  
  h3 {
    color: #000;
    text-align: center;
    margin: 0;
    font-size: 24px;
    font-weight: bold;
  }
  
  .back-btn {
    display: inline-block;
    padding: 8px 16px;
    background: #6c757d;
    color: #fff;
    text-decoration: none;
    border-radius: 6px;
    font-size: 14px;
    transition: all 0.3s;
  }
  
  .back-btn:hover {
    background: #5a6268;
    color: #fff;
    text-decoration: none;
  }
  
  .form-section {
    background: rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    overflow: hidden;
  }
  
  .section-title {
    font-size: 18px;
    font-weight: bold;
    color: #17a2b8;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid rgba(23, 162, 184, 0.3);
  }
  
  .form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
    width: 100%;
    box-sizing: border-box;
  }
  
  .form-group {
    margin-bottom: 15px;
    width: 100%;
    box-sizing: border-box;
  }
  
  .form-label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #495057;
  }
  
  .form-control {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ced4da;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    box-sizing: border-box;
    max-width: 100%;
  }
  
  .form-control:focus {
    border-color: #17a2b8;
    outline: 0;
    box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.25);
  }
  
  .form-control[readonly] {
    background-color: #f8f9fa;
    color: #6c757d;
    cursor: not-allowed;
  }
  
  .form-text {
    font-size: 12px;
    color: #6c757d;
    margin-top: 5px;
  }
  
  .form-check-input {
    margin-right: 8px;
  }
  
  .btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
  }
  
  .btn-primary {
    background: linear-gradient(135deg, #17a2b8, #138496);
    color: white;
  }
  
  .btn-primary:hover {
    background: linear-gradient(135deg, #138496, #117a8b);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(23, 162, 184, 0.4);
    color: white;
    text-decoration: none;
  }
  
  .btn-success {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
  }
  
  .btn-success:hover {
    background: linear-gradient(135deg, #20c997, #17a2b8);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
    color: white;
    text-decoration: none;
  }
  
  .alert {
    padding: 12px 16px;
    margin-bottom: 20px;
    border: 1px solid transparent;
    border-radius: 6px;
  }
  
  .alert-success {
    color: #155724;
    background-color: #d4edda;
    border-color: #c3e6cb;
  }
  
  .alert-danger {
    color: #721c24;
    background-color: #f8d7da;
    border-color: #f5c6cb;
  }
  
  .checkbook-info {
    background: rgba(23, 162, 184, 0.1);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
    backdrop-filter: blur(5px);
    border: 1px solid rgba(23, 162, 184, 0.2);
  }
  
  .checkbook-info h5 {
    color: #17a2b8;
    margin-bottom: 10px;
  }
  
  .checkbook-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    width: 100%;
    box-sizing: border-box;
  }
  
  .stat-item {
    text-align: center;
    padding: 10px;
    background: rgba(255,255,255,0.1);
    border-radius: 6px;
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-sizing: border-box;
  }
  
  .stat-number {
    font-size: 18px;
    font-weight: bold;
    color: #17a2b8;
  }
  
  .stat-label {
    font-size: 12px;
    color: #666;
  }
  
  /* Responsive Design */
  @media (max-width: 768px) {
    .bank-account-edit-container {
      margin: 10px;
      padding: 15px;
      border-radius: 16px;
    }
    
    .form-row {
      grid-template-columns: 1fr;
      gap: 15px;
    }
    
    .page-header {
      flex-direction: column;
      gap: 15px;
      text-align: center;
    }
    
    h3 {
      font-size: 20px;
    }
    
    .form-section {
      padding: 15px;
      margin-bottom: 15px;
    }
    
    .checkbook-stats {
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
    }
  }
  
  @media (max-width: 480px) {
    .bank-account-edit-container {
      margin: 5px;
      padding: 10px;
    }
    
    .form-section {
      padding: 10px;
    }
    
    .form-control {
      font-size: 13px;
      padding: 8px 10px;
    }
    
    .btn {
      padding: 8px 16px;
      font-size: 13px;
    }
  }
</style>

<div class="bank-account-edit-container">
  <div class="page-header">
    <h3>{{ title }}</h3>
    <a href="{% url 'products:bank_account_detail' bank_account.id %}" class="back-btn">
      بازگشت به جزئیات
    </a>
  </div>
  
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
  
  <!-- فرم ویرایش حساب بانکی -->
  <div class="form-section">
    <div class="section-title">ویرایش اطلاعات حساب بانکی</div>
    
    <form method="post">
      {% csrf_token %}
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">{{ form.bank.label }}</label>
          {{ form.bank }}
          {% if form.bank.errors %}
            <div class="alert alert-danger">{{ form.bank.errors.0 }}</div>
          {% endif %}
        </div>
        
        <div class="form-group">
          <label class="form-label">{{ form.title.label }}</label>
          {{ form.title }}
          {% if form.title.errors %}
            <div class="alert alert-danger">{{ form.title.errors.0 }}</div>
          {% endif %}
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">{{ form.account_number.label }}</label>
          {{ form.account_number }}
          {% if form.account_number.errors %}
            <div class="alert alert-danger">{{ form.account_number.errors.0 }}</div>
          {% endif %}
        </div>
        
        <div class="form-group">
          <label class="form-label">{{ form.sheba.label }}</label>
          {{ form.sheba }}
          {% if form.sheba.errors %}
            <div class="alert alert-danger">{{ form.sheba.errors.0 }}</div>
          {% endif %}
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">{{ form.card_number.label }}</label>
          {{ form.card_number }}
          {% if form.card_number.errors %}
            <div class="alert alert-danger">{{ form.card_number.errors.0 }}</div>
          {% endif %}
        </div>
        
        <div class="form-group">
          <label class="form-label">{{ form.account_type.label }}</label>
          {{ form.account_type }}
          {% if form.account_type.errors %}
            <div class="alert alert-danger">{{ form.account_type.errors.0 }}</div>
          {% endif %}
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">{{ form.initial_balance.label }}</label>
          {{ form.initial_balance }}
          {% if form.initial_balance.errors %}
            <div class="alert alert-danger">{{ form.initial_balance.errors.0 }}</div>
          {% endif %}
          <small class="form-text text-muted">{{ form.initial_balance.help_text }}</small>
        </div>
        
        <div class="form-group">
          <label class="form-label">موجودی فعلی</label>
          <input type="text" class="form-control" value="{{ bank_account.current_balance|persian_number_format }} ریال" readonly>
          <small class="form-text text-muted">موجودی فعلی حساب</small>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">{{ form.new_balance.label }}</label>
          {{ form.new_balance }}
          {% if form.new_balance.errors %}
            <div class="alert alert-danger">{{ form.new_balance.errors.0 }}</div>
          {% endif %}
          <small class="form-text text-muted">موجودی جدید محاسبه شده (موجودی اولیه + موجودی فعلی)</small>
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">{{ form.description.label }}</label>
        {{ form.description }}
        {% if form.description.errors %}
          <div class="alert alert-danger">{{ form.description.errors.0 }}</div>
        {% endif %}
      </div>
      
      <button type="submit" class="btn btn-primary">
        <i class="bi bi-check-circle"></i>
        ذخیره تغییرات
      </button>
    </form>
  </div>
  
  <script>
    // محاسبه خودکار موجودی جدید
    document.addEventListener('DOMContentLoaded', function() {
      const initialBalanceInput = document.getElementById('id_initial_balance');
      const newBalanceInput = document.getElementById('id_new_balance');
      const currentBalanceText = document.querySelector('input[value*="ریال"]').value;
      
      // استخراج موجودی فعلی از متن
      const currentBalanceMatch = currentBalanceText.match(/(\d+(?:,\d+)*)/);
      const currentBalance = currentBalanceMatch ? parseFloat(currentBalanceMatch[1].replace(/,/g, '')) : 0;
      
      function updateNewBalance() {
        const initialBalance = parseFloat(initialBalanceInput.value) || 0;
        const newBalance = initialBalance + currentBalance;
        newBalanceInput.value = newBalance.toFixed(2);
      }
      
      // به‌روزرسانی در هنگام تغییر موجودی اولیه
      initialBalanceInput.addEventListener('input', updateNewBalance);
      
      // محاسبه اولیه
      updateNewBalance();
    });
  </script>
  
  <!-- اطلاعات دسته‌های چک موجود -->
  {% if bank_account.checkbooks.all %}
    <div class="form-section">
      <div class="section-title">دسته‌های چک موجود</div>
      
      <div class="checkbook-info">
        <h5>آمار کلی:</h5>
        <div class="checkbook-stats">
          <div class="stat-item">
            <div class="stat-number">{{ bank_account.checkbooks.count }}</div>
            <div class="stat-label">تعداد دسته چک</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">{{ bank_account.checkbooks.all|length }}</div>
            <div class="stat-label">دسته چک فعال</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">
              {% with total_checks=0 %}
                {% for checkbook in bank_account.checkbooks.all %}
                  {% with checkbook.end_number|add:"1"|add:"-"|add:checkbook.start_number as check_count %}
                    {{ total_checks|add:check_count }}
                  {% endwith %}
                {% endfor %}
              {% endwith %}
            </div>
            <div class="stat-label">کل چک‌ها</div>
          </div>
        </div>
      </div>
    </div>
  {% endif %}
  
  <!-- فرم اضافه کردن دسته چک جدید -->
  <div class="form-section">
    <div class="section-title">افزودن دسته چک جدید</div>
    
    <form method="post">
      {% csrf_token %}
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">{{ checkbook_form.bank_account.label }}</label>
          {{ checkbook_form.bank_account }}
          {% if checkbook_form.bank_account.errors %}
            <div class="alert alert-danger">{{ checkbook_form.bank_account.errors.0 }}</div>
          {% endif %}
        </div>
        
        <div class="form-group">
          <label class="form-label">{{ checkbook_form.serial.label }}</label>
          {{ checkbook_form.serial }}
          {% if checkbook_form.serial.errors %}
            <div class="alert alert-danger">{{ checkbook_form.serial.errors.0 }}</div>
          {% endif %}
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">{{ checkbook_form.start_number.label }}</label>
          {{ checkbook_form.start_number }}
          {% if checkbook_form.start_number.errors %}
            <div class="alert alert-danger">{{ checkbook_form.start_number.errors.0 }}</div>
          {% endif %}
        </div>
        
        <div class="form-group">
          <label class="form-label">{{ checkbook_form.end_number.label }}</label>
          {{ checkbook_form.end_number }}
          {% if checkbook_form.end_number.errors %}
            <div class="alert alert-danger">{{ checkbook_form.end_number.errors.0 }}</div>
          {% endif %}
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">
            {{ checkbook_form.is_active }}
            {{ checkbook_form.is_active.label }}
          </label>
          {% if checkbook_form.is_active.errors %}
            <div class="alert alert-danger">{{ checkbook_form.is_active.errors.0 }}</div>
          {% endif %}
        </div>
      </div>
      
      <button type="submit" name="add_checkbook" class="btn btn-success">
        <i class="bi bi-plus-circle"></i>
        افزودن دسته چک
      </button>
    </form>
  </div>
</div>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
{% endblock %} 